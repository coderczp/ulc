<!DOCTYPE html>
<html>
<head>
<title>ULC</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" rel="stylesheet">
<link href="/ulc/css/ulc.css" rel="stylesheet">
<script src="http://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="js/ulc.js"></script>
<body>
  <!--导航-->
  <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
    <div class="container">
      <div class="navbar-header nav-title ">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand " href="index.html">ULC</a>
      </div>
      <div class="collapse navbar-collapse navbar-right is-collapse">
        <ul class="nav navbar-nav" id="menuId"></ul>
      </div>
      <!-- /.nav-collapse -->
    </div>
    <!-- /.container -->
  </div>
  <!--导航-->
  <div class="container-fluid" style="margin-top: 50px">
    <div class="panel panel-success">
      <div class="panel-heading">
        <input type="file" id="myfile" name="file" onchange="doUpload()">
        <label id="tips"></label>
      </div>
      <div class="panel-body">
        <div id="result">
          工程名
          <input type="text" size="8" id="filter" placeholder="输入tar名" onkeyup="updateTar()">
          <select id="tar"></select>
          选择主机
          <select id="hostId" onchange="loadProc()"></select>
          选择工程
          <select id="proc"></select>
          <button id="deploy" onclick="deploy()">发布</button>
          <a href="/ulc/tar.exe">前端打包工具</a>
        </div>
        <div id="list" class="table-responsive">
          <table class="table table-striped">
            <caption>部署记录</caption>
            <thead>
              <tr>
                <th>ID</th>
                <th>服务</th>
                <th>主机</th>
                <th>人员</th>
                <th>状态</th>
                <th>日期</th>
                <th>进度</th>
                <th>日志</th>
              </tr>
            </thead>
            <tbody id="record">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Deploy log</h4>
        </div>
        <div class="modal-body">
          <div class="div">
            <textarea id="logDetail" rows="20" cols="75" style="background: black; color: white;"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- /.modal -->
</body>
<script type="text/javascript">
	var waitImg = '<img src="/ulc/img/wait.gif" style="width: 30px; height: 30px;"/>';

	function updateTar() {
		var val = $('#filter').val();
		if (val)
			loadFiles(val);
	}

	function getProject(file) {
		return file.substring(file.indexOf('_') + 1, file.lastIndexOf("."));
	}

	function loadFiles(filter) {
		var arg = {
			"size" : 30,
			"query" : filter || "",
		};
		$.get('./project/listtar?size=30', arg, function(d) {
			var html = '';
			for ( var i in d) {
				var file = d[i];
				var project = getProject(file);
				var time = file.substring(0, file.indexOf("_"));
				html += buildOpt(file, project + "[" + time + "]");
			}
			$('#tar').html(html);
		});
	}

	function loadRecord() {
		$.get('./project/record?size=15', function(d) {
			var html = '';
			for ( var i in d) {
				var record = d[i];
				var id = record.id;
				var rlog = record.log;
				var prg = isFinish(record) ? "完成" : waitImg;
				var log = "<button onclick='loadLog(" + id + ")'>日志</button>";

				html += "<tr><td>" + record.id + "</td><td>" + record.project
						+ "</td><td>" + record.host + "</td><td>"
						+ record.author + "</td><td>" + record.status
						+ "</td><td>" + record.time + "</td><td>" + prg
						+ "</td><td>" + log + "</td></tr>";
			}
			$('#record').html(html);
		});
	}

	function openLog(log) {
		try {
			$('#logDetail').html(log);
			$('#myModal').modal('show');
		} catch (e) {
			console.log(e)
		}
	}

	function loadLog(id) {
		$.get('./project/queryLog?id=' + id, function(d) {
			openLog(d);
		});
	}

	function loadProc() {
		var hostId = $('#hostId').val();
		$.get('./project/getProc?hostId=' + hostId, function(procs) {
			var html = "";
			for ( var i in procs) {
				var item = procs[i];
				var id = item.id;
				var name = item.name;
				html += buildOpt(id, name);
			}
			$('#proc').html(html);
		});
	}

	function buildOpt(val, text) {
		return '<option value='+val+'>' + text + '</option>';
	}

	function doUpload() {
		var formData = new FormData();
		$('#tips').text("正在上传,请稍等");
		formData.append("file", document.getElementById("myfile").files[0]);
		$.ajax({
			url : "/ulc/file/upload",
			type : "POST",
			data : formData,
			contentType : false,//必须false才会自动加上正确的Content-Type
			processData : false,//必须false才会避开jQuery对 formdata
			success : function(data) {
				$('#tips').text(data.path || data.error);
				loadFiles();
			}
		});
	}

	function findTd(id, d) {
		$("#record > tr").each(function() {
			var cid = $(this).children('td:eq(0)').text();
			if (cid == id) {
				statusTd = $(this).children('td:eq(4)');
				logTd = $(this).children('td:eq(7)');
				prgTd = $(this).children('td:eq(6)');
				statusTd.text(d.status);
			}
		});
	}

	var statusTd, logTd, prgTd;
	function doCheck(id) {
		$.get('./project/check?id=' + id, function(d) {
			if (!statusTd) {
				findTd(id, d);
			}
			statusTd.text(d.status);
			if (!isFinish(d)) {
				window.setTimeout(doCheck, 1000, id);
			} else {
				prgTd.html("完成");
				openLog(d.log)
			}
		});
	}

	function isFinish(redocrd) {
		var status = redocrd.status;
		if (status)
			return status.match('部署完成|部署失败|部署成功') != null;
	}

	function startCheck(id) {
		window.setTimeout(doCheck, 1000, id);
	}

	function deploy() {
		var tar = $('#tar').val();
		var proc = $('#proc').val();
		var host = $('#hostId').val();
		var hostName = $("#hostId").find("option:selected").text();
		if (!host || !tar || !proc)
			return alert('请选择主机 文件 工程');

		if (hostName.indexOf('online') > -1) {
			var a = confirm("确认测试环境ok,并部署到线上吗?");
			if (a == false)
				return;
		}
		$.post('./project/deploy', {
			"tar" : $('#tar').val(),
			"procId" : $('#proc').val(),
			"hostId" : $('#hostId').val(),
		}, function(d) {
			if (d.code == 200)
				startCheck(d.id);
			loadRecord();
		});
		$("#imgWait").show();
	}

	$(function() {
		bindMenus('#menuId');
		asynLoadHost('#hostId');
		loadFiles();
		loadRecord();
	});
</script>
</body>